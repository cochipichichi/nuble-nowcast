<!doctype html><html lang="es" data-theme="dark"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Mapa — Ñuble Nowcast</title>
<link rel="icon" href="assets/icons/icon-192.png"><link rel="stylesheet" href="css/style.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/><script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script></head>
<body><header class="header"><div class="brand"><span class="logo"></span><strong>Mapa</strong></div><nav><a class="btn" href="./index.html">Inicio</a> <a class="btn" href="./history.html">📚 Historial</a> <a class="btn" href="./kiosk.html">📺 Kiosko</a></nav></header>
<main class="container"><section class="card"><h1>🗺️ Radar & FIRMS</h1>
<label><input type="checkbox" id="radar" checked> 🌧️ Radar</label> <label><input type="checkbox" id="firms"> 🔥 FIRMS</label>
<div id="map" class="leaflet-container"></div></section></main>
<script type="module">
import {getLayers} from './js/data/offline.js'; import {getRainViewerTemplate,getFIRMSUrl} from './js/data/live.js';
const map=L.map('map').setView([-36.49,-72.20],9); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);
let radar=null,firms=null; async function addRadar(){ if(radar) return radar; const t=await getRainViewerTemplate(); radar=L.tileLayer(t,{opacity:.6,attribution:'Radar © RainViewer'}); return radar; }
function addFirms(){ if(firms) return firms; const wms=getFIRMSUrl(); if(!wms){alert('Configura FIRMS_MAP_KEY'); return null;} firms=L.tileLayer.wms(wms,{layers:'fires_modis_24',format:'image/png',transparent:true,attribution:'FIRMS/NASA'}); return firms; }
document.getElementById('radar').addEventListener('change',async e=>{ if(e.target.checked){const l=await addRadar(); if(l) l.addTo(map);} else if(radar){map.removeLayer(radar);} });
document.getElementById('firms').addEventListener('change', e=>{ if(e.target.checked){const l=addFirms(); if(l) l.addTo(map);} else if(firms){map.removeLayer(firms);} });
(async()=>{ const gj=await getLayers(); const Lyr=L.geoJSON(gj,{pointToLayer:(f,latlng)=>L.circleMarker(latlng,{radius:8,color:'#d29922'}),onEachFeature:(f,l)=>l.bindPopup(`<strong>${f.properties.name}</strong><br><span class='meta'>${f.properties.risk||''}</span>`)}).addTo(map); map.fitBounds(Lyr.getBounds(),{padding:[20,20]}); const l=await addRadar(); if(l) l.addTo(map); })();
</script></body></html>